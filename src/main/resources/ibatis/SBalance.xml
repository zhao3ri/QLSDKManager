<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="SBalance">
    <typeAlias alias="SBalance" type="com.item.domain.SBalance"/>
    <typeAlias alias="mb" type="core.module.orm.MapBean"/>

    <!-- 动态条件 -->
    <sql id="SBalance.Where">
        <dynamic prepend="WHERE">
            <isNotNull prepend="AND" property="id">
                sb.id=#id#
            </isNotNull>
            <isNotNull prepend="AND" property="channelId">
                sb.channelId=#channelId#
            </isNotNull>
            <isNotNull prepend="AND" property="createTime">
                sb.createTime=#createTime#
            </isNotNull>
            <isNotEmpty prepend="and" property="channelIds">
                sb.channelId IN
                <iterate property="channelIds" open="(" close=")" conjunction=",">
                    #channelIds[]#
                </iterate>
            </isNotEmpty>
            <isNotNull prepend="AND" property="channelName">
                bp.`channelName` like '%$channelName$%'
            </isNotNull>
        </dynamic>
    </sql>

    <!-- 增加联运渠道 -->
    <insert id="SBalance.save" parameterClass="SBalance">
        INSERT INTO s_balance(channelId,type,amount,user,balance,createTime)
        VALUES(#channelId#,#type#,#amount#,#user#,#balance#,#createTime#)
        <selectKey resultClass="Long" keyProperty="id">
            select @@IDENTITY
            as `id`
        </selectKey>
    </insert>

    <!-- 获取加币记录总数 -->
    <select id="SBalance.count" resultClass="Long" parameterClass="mb">
        SELECT COUNT(1) FROM s_balance sb RIGHT JOIN b_channel bp ON
        sb.channelId=bp.id
        <include refid="SBalance.Where"/>
    </select>

    <!--根据pageSize获取一页的数据量 -->
    <select id="SBalance.page" parameterClass="mb" resultClass="SBalance">
        SELECT sb.*,bp.channelName FROM s_balance sb RIGHT JOIN b_channel bp ON
        sb.channelId=bp.id
        <include refid="SBalance.Where"/>
        <isNotNull property="orderby">
            ORDER BY $orderby$
        </isNotNull>
        LIMIT #firstResult#, #pageSize#
    </select>

    <select id="SBalance.getAllBalance" parameterClass="mb" resultClass="SBalance">
        SELECT
        sb.*,bp.channelName
        FROM s_balance sb JOIN b_channel bp ON sb.channelId=bp.id
        <include refid="SBalance.Where"/>
    </select>

</sqlMap>