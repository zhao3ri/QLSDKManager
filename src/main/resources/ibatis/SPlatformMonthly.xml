<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="SPlatformMonthly">

    <!--<cache type="org.mybatis.caches.ehcache.EhcacheCache"/> -->

    <typeAlias alias="sPlatformMonthly" type="com.item.domain.SPlatformMonthly"/>
    <typeAlias alias="mb" type="core.module.orm.MapBean"/>

    <sql id="SPlatformMonthly.where">
        <dynamic prepend="WHERE">
            <isNotNull prepend="AND" property="id">
                spm.id=#id#
            </isNotNull>
            <isNotNull prepend="AND" property="clientType">
                spm.clientType=#clientType#
            </isNotNull>
            <isNotNull prepend="AND" property="gameId">
                spm.gameId=#gameId#
            </isNotNull>
            <isNotNull prepend="AND" property="yearMonth">
                spm.yearMonth=#yearMonth#
            </isNotNull>
            <isNotEmpty prepend="AND" property="gameIds">
                <![CDATA[ spm.gameId in ]]>
                <iterate property="gameIds" conjunction="," open="(" close=")">
                    #gameIds[]#
                </iterate>
            </isNotEmpty>

            <isNotNull prepend="AND" property="platformId">
                spm.platformId=#platformId#
            </isNotNull>
            <isNotNull prepend="AND" property="totalRoledUser">
                spm.totalRoledUser=#totalRoledUser#
            </isNotNull>
            <isNotNull prepend="AND" property="totalRegUser">
                spm.totalRegUser=#totalRegUser#
            </isNotNull>
            <isNotNull prepend="AND" property="devices">
                spm.devices=#devices#
            </isNotNull>
            <isNotNull prepend="AND" property="payAmount">
                spm.payAmount=#payAmount#
            </isNotNull>
            <isNotNull prepend="AND" property="payTimes">
                spm.payTimes=#payTimes#
            </isNotNull>
            <isNotNull prepend="AND" property="payUsers">
                spm.payUsers=#payUsers#
            </isNotNull>
            <isNotNull prepend="AND" property="gameName">
                bg.gameName=#gameName#
            </isNotNull>
            <isNotNull prepend="AND" property="activeUsers">
                spm.activeUsers=#activeUsers#
            </isNotNull>
        </dynamic>
    </sql>

    <select id="SPlatformMonthly.listApp" resultClass="sPlatformMonthly" parameterClass="mb">
        SELECT
        SUM(spm.devices) as devices,
        SUM(spm.payAmount) as payAmount,
        SUM(spm.payTimes) as payTimes,
        SUM(spm.payUsers) as payUsers,
        SUM(spm.totalRegUser) as totalRegUser,
        SUM(spm.totalRoleUser) as totalRoleUser,
        SUM(spm.activeUsers) as activeUsers,
        bp.platformName as platformName,
        bg.gameName as gameName
        FROM s_platform_monthly spm
        JOIN b_platform bp ON spm.platformId=bp.id
        JOIN b_game bg ON spm.gameId=bg.id
        <include refid="SPlatformMonthly.where"/>
        GROUP BY bp.platformName,bg.gameName
        ORDER BY bg.gameName,bp.platformName,spm.clientType
    </select>


    <select id="SPlatformMonthly.listPlatform" resultClass="sPlatformMonthly" parameterClass="mb">
        SELECT
        bp.platformName as platformName,
        SUM(spm.activeUsers) as activeUsers,
        SUM(spm.devices) as devices,
        SUM(spm.payAmount) as payAmount,
        SUM(spm.payTimes) as payTimes,
        SUM(spm.payUsers) as payUsers,
        SUM(spm.totalRegUser) as totalRegUser,
        SUM(spm.totalRoleUser) as totalRoleUser
        FROM s_platform_monthly spm
        JOIN b_platform bp ON spm.platformId=bp.id
        JOIN b_game bg ON spm.gameId=bg.id
        <include refid="SPlatformMonthly.where"/>
        GROUP BY bp.platformName
        ORDER BY bp.platformName
    </select>

    <select id="SPlatformMonthly.getByMap" resultClass="sPlatformMonthly" parameterClass="mb">
        SELECT
        gameId AS gameId,
        clientType AS clientType,
        totalRoleUser AS totalRoleUser,
        totalRegUser AS totalRegUser,
        devices AS devices,
        activeUsers AS activeUsers,
        payAmount AS payAmount,
        payTimes AS payTimes,
        payUsers AS payUsers
        FROM s_platform_monthly spm
        <include refid="SPlatformMonthly.where"/>
    </select>

    <select id="SPlatformMonthly.stat" resultClass="sPlatformMonthly" parameterClass="mb">
        SELECT
        sd.gameId as gameId,
        sd.clientType as clientType,
        sd.platformId as platformId,
        SUM(sd.roleUsers) as totalRoleUser,
        SUM(sd.regUsers) as totalRegUser,
        SUM(sd.regDevices) as devices,
        SUM(sd.activeUsers) as activeUsers,
        SUM(sd.payAmount) as payAmount,
        SUM(sd.payTimes) as payTimes,
        SUM(sd.payUsers) as payUsers,
        SUM(sd.newUserPays) AS totalNewPayUser
        FROM
        s_platform_daily sd
        <dynamic prepend="where">
            <isNotNull prepend="and" property="clientType">
                sd.clientType=#clientType#
            </isNotNull>
            <isNotNull prepend="and" property="gameId">
                sd.gameId=#gameId#
            </isNotNull>
            <isNotEmpty prepend="and" property="statDate">
                sd.statDate=#statDate#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="platformId">
                sd.platformId=#platformId#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="month">
                sd.statDate LIKE '$month$%'
            </isNotEmpty>
        </dynamic>
        <isNotEmpty property="groupby">
            GROUP BY $groupby$
        </isNotEmpty>
    </select>

</sqlMap>