<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="SGame">

    <!--<cache type="org.mybatis.caches.ehcache.EhcacheCache"/>-->

    <typeAlias alias="sGameMonthly" type="com.item.domain.SGameMonthly"/>
    <typeAlias alias="mb" type="core.module.orm.MapBean"/>

    <sql id="sGameMonthly.Where">
        <dynamic prepend="where">
            <isNotNull prepend="and" property="id">
                sg.`id`=#id#
            </isNotNull>
            <isNotNull prepend="and" property="clientType">
                sg.`clientType`=#clientType#
            </isNotNull>
            <isNotNull prepend="and" property="gameId">
                sg.`gameId`=#gameId#
            </isNotNull>
            <isNotNull prepend="and" property="statDate">
                sg.`statDate`=#statDate#
            </isNotNull>
            <isNotNull prepend="and" property="yearMonth">
                sg.`yearMonth`=#yearMonth#
            </isNotNull>
            <isNotEmpty prepend="AND" property="gameIds">
                sg.gameId IN
                <iterate property="gameIds" open="(" close=")" conjunction=",">
                    #gameIds[]#
                </iterate>
            </isNotEmpty>
        </dynamic>
    </sql>

    <select id="sGameMonthly.summary" resultClass="sGameMonthly" parameterClass="mb">
        SELECT
        gameId AS gameId,
        clientType AS clientType,
        totalRoleUser AS totalRoleUser,
        totalRegUser AS totalRegUser,
        devices AS devices,
        activeUsers AS activeUsers,
        payAmount AS payAmount,
        payTimes AS payTimes,
        payUsers AS payUsers,
        newUserPays AS totalNewPayUser
        FROM s_game_monthly sg
        <include refid="sGameMonthly.Where"/>
    </select>

    <select id="sGameMonthly.stat" resultClass="sGameMonthly" parameterClass="mb">
        SELECT
        sd.gameId as gameId,
        sd.clientType as clientType,
        SUM(sd.roleUsers) as totalRoleUser,
        SUM(sd.regUsers) as totalRegUser,
        SUM(sd.regDevices) as devices,
        SUM(sd.activeUsers) as activeUsers,
        SUM(sd.payAmount) as payAmount,
        SUM(sd.payTimes) as payTimes,
        SUM(sd.payUsers) as payUsers,
        SUM(sd.newUserPays) AS totalNewPayUser
        FROM
        s_game_daily sd
        <dynamic prepend="where">
            <isNotNull prepend="and" property="clientType">
                sd.clientType=#clientType#
            </isNotNull>
            <isNotNull prepend="and" property="gameId">
                sd.gameId=#gameId#
            </isNotNull>
            <isNotEmpty prepend="and" property="statDate">
                sd.statDate=#statDate#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="month">
                sd.statDate LIKE '$month$%'
            </isNotEmpty>
        </dynamic>
        <isNotEmpty property="groupby">
            GROUP BY $groupby$
        </isNotEmpty>
    </select>

    <!--<insert id="sGameMonthly.save" parameterClass="sGameMonthly">-->
    <!--INSERT INTO-->
    <!--s_game_monthly(gameId,clientType,yearMonth,totalRoleUser,totalRegUser,devices,payAmount,payTimes,payUsers,activeUsers,newUserPayAmount,newUserPays,monthLoginRoles)-->
    <!--VALUES(#gameId#,#clientType#,#yearMonth#,#totalRoleUser#,#totalRegUser#,#devices#,#payAmount#,#payTimes#,#payUsers#,#activeUsers#,#newUserPayAmount#,#newUserPays#,#monthLoginRoles#)-->
    <!--<selectKey resultClass="Long" keyProperty="id">-->
    <!--select @@IDENTITY as `id`-->
    <!--</selectKey>-->
    <!--</insert>-->
</sqlMap>