<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="BPlatformGame">
    <typeAlias alias="BPlatformGame" type="com.item.domain.BPlatformGame"/>
    <typeAlias alias="BPlatform" type="com.item.domain.BPlatform"/>
    <typeAlias alias="Game" type="com.item.domain.Game"/>
    <typeAlias alias="mb" type="core.module.orm.MapBean"/>

    <sql id="BPlatformGame.Where">
        <dynamic prepend="WHERE">
            <isNotNull prepend="AND" property="id">
                bpg.id=#id#
            </isNotNull>
            <isNotNull prepend="AND" property="platformId">
                bpg.platformId=#platformId#
            </isNotNull>
            <isNotNull prepend="AND" property="gameId">
                bpg.gameId=#gameId#
            </isNotNull>
            <isNotNull prepend="AND" property="configParams">
                bpg.configParams=#configParams#
            </isNotNull>
            <isNotNull prepend="AND" property="createTime">
                bpg.createTime=#createTime#
            </isNotNull>
            <isNotEmpty prepend="AND" property="gameIds">
                bpg.gameId IN
                <iterate property="gameIds" open="(" close=")" conjunction=",">
                    #gameIds[]#
                </iterate>
            </isNotEmpty>
            <isNotEmpty prepend="and" property="platformIds">
                bpg.platformId IN
                <iterate property="platformIds" open="(" close=")" conjunction=",">
                    #platformIds[]#
                </iterate>
            </isNotEmpty>
        </dynamic>
    </sql>

    <select id="BPlatformGame.count" resultClass="Long"
            parameterClass="mb">
        SELECT COUNT(*) FROM b_platform_game bpg
        JOIN b_platform bp ON bpg.platformId=bp.id
        JOIN b_game bg ON bpg.gameId=bg.id
        <include refid="BPlatformGame.Where"/>
    </select>

    <select id="BPlatformGame.page" resultClass="BPlatformGame"
            parameterClass="mb">
        SELECT
        bpg.id,bp.platformName,bg.gameName,bpg.configParams,bpg.createTime,bpg.gameId,bpg.platformId,bpg.discount
        FROM b_platform_game bpg
        JOIN b_platform bp ON bpg.platformId=bp.id
        JOIN b_game bg ON bpg.gameId=bg.id
        <include refid="BPlatformGame.Where"/>
        <isNotNull property="orderby">
            ORDER BY $orderby$
        </isNotNull>
        LIMIT #firstResult#, #pageSize#
    </select>

    <select id="BPlatformGame.list" resultClass="BPlatformGame" parameterClass="mb">
        SELECT
        bpg.*,bp.platformName,bg.gameName
        FROM b_platform_game bpg
        JOIN b_platform bp ON bpg.platformId=bp.id
        JOIN b_game bg ON bpg.gameId=bg.id
        <include refid="BPlatformGame.Where"/>
    </select>

    <delete id="BPlatformGame.delete" parameterClass="Long">
		DELETE FROM b_platform_game WHERE id=#id#
	</delete>

    <select id="BPlatformGame.GetByAppId" resultClass="BPlatformGame" parameterClass="Long">
		SELECT 
			a.platformId,
			b.platformName
		FROM b_platform_game AS a 
		JOIN b_platform AS b ON a.platformId = b.id
		WHERE a.gameId = #gameId#
	</select>

    <select id="BPlatformGame.getPlatformAppById" parameterClass="Long"
            resultClass="BPlatformGame">
		SELECT bp.platformName,bg.gameName,bg.id as gameId,bpg.*
		FROM b_platform_game bpg
		JOIN b_platform bp ON bpg.platformId=bp.id
		JOIN b_game bg ON bpg.gameId=bg.id
		WHERE bpg.id=#id#
	</select>

    <select id="BPlatformGame.getAllPlatform" resultClass="BPlatform">
		SELECT * FROM b_platform
	</select>

    <select id="BPlatformGame.getAllApp" resultClass="Game">
		SELECT * FROM b_game
	</select>

    <update id="BPlatformGame.update" parameterClass="BPlatformGame">
        UPDATE b_platform_game
        <dynamic prepend="SET">
            <isNotNull prepend="," property="platformId">
                platformId=#platformId#
            </isNotNull>
            <isNotNull prepend="," property="gameId">
                gameId=#gameId#
            </isNotNull>
            <isNotNull prepend="," property="configParams">
                configParams=#configParams#
            </isNotNull>
            <isNotNull prepend="," property="status">
                status=#status#
            </isNotNull>
            <isNotNull prepend="," property="registStatus">
                registStatus=#registStatus#
            </isNotNull>
            <isNotNull prepend="," property="discount">
                discount=#discount#
            </isNotNull>
        </dynamic>
        WHERE id=#id#
    </update>

    <insert id="BPlatformGame.save" parameterClass="BPlatformGame">
        INSERT INTO
        b_platform_game(platformId,gameId,configParams,createTime,status,registStatus,discount,appKey,secretKey,appID,privateKey,publicKey)
        VALUES(#platformId#,#gameId#,#configParams#,#createTime#,#status#,#registStatus#,#discount#,#appKey#,#secretKey#,#appID#,#privateKey#,#publicKey#)
        <selectKey resultClass="Long" keyProperty="id">
            select @@IDENTITY as `id`
        </selectKey>
    </insert>

</sqlMap>