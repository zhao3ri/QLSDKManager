<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="SChannel">

	<!--<cache type="org.mybatis.caches.ehcache.EhcacheCache"/> -->

	<typeAlias alias="sChannel" type="com.item.domain.SChannel" />
	<typeAlias alias="mb" type="core.module.orm.MapBean" />

	<sql id="SChannel.where">
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="id">
				sp.id=#id#
			</isNotNull>
			<isNotNull prepend="AND" property="clientType">
				sp.clientType=#clientType#
			</isNotNull>
			<isNotNull prepend="AND" property="gameId">
				sp.gameId=#gameId#
			</isNotNull>
			<isNotEmpty prepend="AND" property="gameIds">
		          <![CDATA[ sp.gameId in ]]>
		          <iterate property="gameIds" conjunction="," open="(" close=")">
		              #gameIds[]#
		          </iterate>
	    	</isNotEmpty>
			<isNotNull prepend="AND" property="statDate">
				sp.statDate=#statDate#
			</isNotNull>
			<isNotNull prepend="AND" property="channelId">
				sp.channelId=#channelId#
			</isNotNull>
		</dynamic>
	</sql>

	<select id="SChannel.getByMap" resultClass="sChannel"
		parameterClass="mb">
		SELECT
			clientType,
	    	totalRoleUser,
			totalRegUser,
			devices,
			payAmount,
			payTimes,
			payUsers,
			activeUsers,
			statDate
		FROM s_channel_history sp
		<include refid="SChannel.where" />
		GROUP BY clientType
	</select>

	<select id="SChannel.maxDateDataGame" resultClass="sChannel"
		parameterClass="mb">	
		SELECT
			SUM(sp.payAmount) as payAmount,
			SUM(sp.payTimes) as payTimes,
			SUM(sp.payUsers) as payUsers,
			SUM(sp.totalRegUser) as totalRegUser,
			SUM(sp.totalRoleUser) as totalRoleUser,
			SUM(sp.devices) as devices,
			SUM(sp.activeUsers) as activeUsers,
			bp.channelName as channelName,
			bg.gameName as gameName
		FROM s_channel_history sp
		JOIN b_channel bp ON sp.channelId=bp.id
		JOIN b_game bg ON sp.gameId=bg.id
		<include refid="SChannel.where" />
		GROUP BY bp.channelName,bg.gameName
		ORDER BY bg.gameName,bp.channelName,sp.clientType
	</select>

	<select id="SChannel.maxDateDataChannel" resultClass="sChannel"
		parameterClass="mb">
		SELECT
			bp.channelName as channelName,
			SUM(sp.payAmount) as payAmount,
			SUM(sp.payTimes) as
			payTimes,
			SUM(sp.payUsers) as payUsers,
			SUM(sp.totalRegUser) as totalRegUser,
			SUM(sp.totalRoleUser) as totalRoleUser,
			SUM(sp.devices) as devices,
			SUM(sp.activeUsers) as activeUsers
		FROM s_channel_history sp
		JOIN b_channel bp ON sp.channelId=bp.id
		JOIN b_game bg ON sp.gameId=bg.id
		<include refid="SChannel.where" />
		GROUP BY bp.channelName
	</select>

	<select id="SChannel.getLastDayGameData" resultClass="sChannel"
			parameterClass="mb">
		SELECT
		sp.gameId as gameId,
		sp.channelId as channelId,
		SUM(sp.payAmount) as payAmount,
		SUM(sp.payTimes) as payTimes,
		SUM(sp.payUsers) as payUsers,
		SUM(sd.newUserPays) as totalNewPayUser,
		SUM(sp.totalRegUser) as totalRegUser,
		SUM(sp.totalRoleUser) as totalRoleUser,
		SUM(sp.devices) as devices,
		SUM(sp.activeUsers) as activeUsers,
		bp.channelName as channelName,
		bg.gameName as gameName
		FROM s_channel_history sp
		JOIN s_channel_daily sd ON sp.channelId=sd.channelId
		JOIN b_channel bp ON sp.channelId=bp.id
		JOIN b_game bg ON sp.gameId=bg.id
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="id">
				sp.id=#id#
			</isNotNull>
			<isNotNull prepend="AND" property="clientType">
				sp.clientType=#clientType#
			</isNotNull>
			<isNotNull prepend="AND" property="gameId">
				sp.gameId=#gameId#
			</isNotNull>
			<isNotEmpty prepend="AND" property="gameIds">
				<![CDATA[ sp.gameId in ]]>
				<iterate property="gameIds" conjunction="," open="(" close=")">
					#gameIds[]#
				</iterate>
			</isNotEmpty>
			<isNotNull prepend="AND" property="statDate">
				sp.statDate=$statDate$
			</isNotNull>
			<isNotNull prepend="AND" property="channelId">
				sp.channelId=#channelId#
			</isNotNull>
		</dynamic>
		GROUP BY bp.channelName,bg.gameName
		ORDER BY bg.gameName,bp.channelName,sp.clientType
	</select>

	<select id="SChannel.getLastDayChannelData" resultClass="sChannel"
			parameterClass="mb">
		SELECT
		bp.channelName as channelName,
		SUM(sp.payAmount) as payAmount,
		SUM(sp.payTimes) as payTimes,
		SUM(sp.payUsers) as payUsers,
		SUM(sd.newUserPays) as totalNewPayUser,
		SUM(sp.totalRegUser) as totalRegUser,
		SUM(sp.totalRoleUser) as totalRoleUser,
		SUM(sp.devices) as devices,
		SUM(sp.activeUsers) as activeUsers
		FROM s_channel_history sp
		JOIN s_channel_daily sd ON sp.channelId=sd.channelId
		JOIN b_channel bp ON sp.channelId=bp.id
		JOIN b_game bg ON sp.gameId=bg.id
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="id">
				sp.id=#id#
			</isNotNull>
			<isNotNull prepend="AND" property="clientType">
				sp.clientType=#clientType#
			</isNotNull>
			<isNotNull prepend="AND" property="gameId">
				sp.gameId=#gameId#
			</isNotNull>
			<isNotEmpty prepend="AND" property="gameIds">
				<![CDATA[ sp.gameId in ]]>
				<iterate property="gameIds" conjunction="," open="(" close=")">
					#gameIds[]#
				</iterate>
			</isNotEmpty>
			<isNotNull prepend="AND" property="statDate">
				sp.statDate=$statDate$
			</isNotNull>
			<isNotNull prepend="AND" property="channelId">
				sp.channelId=#channelId#
			</isNotNull>
		</dynamic>
		GROUP BY bp.channelName
	</select>
</sqlMap>